<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Setting up alert notifications to Slack - FHIR Server Docs</title>
<meta name="description" content="Receive notifications about the health of your cluster based on monitored metrics.">

<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="FHIR Server Docs">
<meta property="og:url" content="http://localhost:4000/FHIR-Server-Docs/tutorials/monitoring-alerts/" />
<meta property="og:title" content="Tutorials | Setting up alert notifications to Slack" />
<meta property="og:description" content="Receive notifications about the health of your cluster based on monitored metrics." />

<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="IBM Event Streams | Setting up alert notifications to Slack" />




  <meta property="og:description" content="Receive notifications about the health of your cluster based on monitored metrics.">



  <meta property="og:image" content="http://localhost:4000/FHIR-Server-Docs/assets/siteMeta/appIcon_og_fb.png">
  <meta name="twitter:image" content="http://localhost:4000/FHIR-Server-Docs/assets/siteMeta/appIcon_og_square.png">



  <meta property="article:published_time" content="2021-03-12T16:58:25+00:00">






<link rel="canonical" href="http://localhost:4000/FHIR-Server-Docs/tutorials/monitoring-alerts/">





  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "http://localhost:4000/FHIR-Server-Docs",
      "logo": "http://localhost:4000/FHIR-Server-Docs/assets/siteMeta/appIcon_og_fb.png"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "IBM",
      "url": "http://localhost:4000/FHIR-Server-Docs",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/FHIR-Server-Docs/feed.xml" type="application/atom+xml" rel="alternate" title="FHIR Server Docs Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/FHIR-Server-Docs/assets/css/main.css">



<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<link rel="shortcut icon" type="image/png" href="http://localhost:4000/FHIR-Server-Docs/assets/siteMeta/favicon.ico"/>
<link rel="shortcut icon" type="image/png" href="http://localhost:4000/FHIR-Server-Docs/assets/siteMeta/fhir-icon-16.png"/>
<link rel="shortcut icon" type="image/png" href="http://localhost:4000/FHIR-Server-Docs/assets/siteMeta/fhir-icon3.png"/>
<link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/FHIR-Server-Docs/assets/siteMeta/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:4000/FHIR-Server-Docs/assets/siteMeta/fhir-icon3.png">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:4000/FHIR-Server-Docs/assets/siteMeta/fhir-icon-16.png">
<link rel="manifest" href="http://localhost:4000/FHIR-Server-Docs/assets/siteMeta/site.webmanifest">
<link rel="mask-icon" href="http://localhost:4000/FHIR-Server-Docs/assets/siteMeta/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#000000">
<meta name="theme-color" content="#000000">

<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,600%7CIBM+Plex+Serif:300,400,500%7CIBM+Plex+Mono:300,400,500,700" rel="stylesheet">

<!-- end custom head snippets -->

    <link rel="shortcut icon" type="image/x-icon" href="/FHIR-Server-Docs/assets/favicon.ico" >
    
    <base target="_parent">

  </head>
  <script src="/FHIR-Server-Docs/assets/animation/lottie.js" type="text/javascript"></script>
  <script src="/FHIR-Server-Docs/assets/js/connectors.js"></script>


  
  <body onload="" class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    




 <div id="masthead" class="masthead">
  <div class="masthead__goToIBMCloud">
 <!-- <div>
    You are viewing the documentation for the container-native version of IBM FHIR Server.
  </div> 
   <a class="link" target="_self" href="https://www.ibm.com/products/fhir-server">Looking for the managed service on IBM Cloud? Click here.</a> -->
</div> 
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="mastheadNav">

      


        <div class="mastheadTitle">
          
          <a class="site-title" href="/FHIR-Server-Docs/" target="_self"><span>IBM</span>&nbsp;FHIR Server</a>
          <div class="viewOnIBMcom">
            <a href="https://www.ibm.com/products/fhir-server" target="_blank">View product page</a>
          </div>
        </div>









        <div class="mastheadControls">
            <div class="menuScrollContainer">

        

                <ul id="visible-links" class="visible-links">
                  
                  
                  

                  




                  
                    <li class="masthead__menu-item " onclick="window.open('http://localhost:4000/FHIR-Server-Docs/','_self')">
                      <a href="http://localhost:4000/FHIR-Server-Docs/" >Documentation</a>
                    </li>
                  

                  
                  
                  

                  




                  
                    <li class="masthead__menu-item active" onclick="window.open('http://localhost:4000/FHIR-Server-Docs/tutorials/','_self')">
                      <a href="http://localhost:4000/FHIR-Server-Docs/tutorials/" >Tutorials</a>
                    </li>
                  

                  
                  
                  

                  




                  
                    <li class="masthead__menu-item " onclick="window.open('http://localhost:4000/FHIR-Server-Docs/faq/','_self')">
                      <a href="http://localhost:4000/FHIR-Server-Docs/faq/" >FAQ</a>
                    </li>
                  

                  
                  
                  

                  




                  
                    <li class="masthead__menu-item " onclick="window.open('http://localhost:4000/FHIR-Server-Docs/support/','_self')">
                      <a href="http://localhost:4000/FHIR-Server-Docs/support/" >Support</a>
                    </li>
                  

                  
                  
                  

                  




                  
                    <li class="masthead__menu-item " onclick="window.open('http://localhost:4000/FHIR-Server-Docs/search/','_self')">
                      <button aria-label="Search Button" role="button" id="searchButton" class="search__toggle " type="button" name="search Button">
                        <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                          <path
                            d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z"
                            transform="translate(-.01)"></path>
                        </svg>
                      </button>
                    </li>
                  

                  
                </ul>
        

      </div>
    </div>
      </nav>
    </div>
  </div>
</div>


    <div id="initial-content" class="initial-content" role="main">





<main id="main" class="mainContainer" role="main">
    

    
  



  <div class="mainContent">
    
      
      
      <div class="subMenu backMenu"> 
    <a href="
        http://localhost:4000/FHIR-Server-Docs/tutorials
      "><img alt="" role="presentation" src="http://localhost:4000/FHIR-Server-Docs/assets/images/icons/previous.svg" />
        Back to tutorials
      </a>
  </div>
    
    <div id="pageContainer" class="page" itemscope itemtype="http://schema.org/CreativeWork">
      <div class="page__inner-wrap  ">
        
        <section class="page__content pageSpacing" itemprop="text">
          
          <header>
            <h1 id="page-title" class="page__title" itemprop="headline">
              Setting up alert notifications to Slack
</h1>
            
          </header>
          
          <div class="content">
            <p>Receiving notifications based on monitored metrics is an important way of keeping an eye on the health of your cluster. You can set up notifications to be sent to applications like Slack based on pre-defined triggers.</p>

<p>The following tutorial shows an example of how to set up alert notifications to be sent to Slack based on metrics from Event Streams.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li>Ensure you have an Event Streams installation available. This tutorial is based on Event Streams version 2019.1.1 installed on IBM Cloud Private 3.1.1, using the default master port 8443.</li>
  <li>Ensure you have <a href="https://slack.com/" target="_blank">Slack</a> installed and ready to use. This tutorial is based on Slack version 3.3.8.</li>
  <li>You need to be a Workplace Administrator to add apps to a Slack channel.</li>
</ul>

<h2 id="preparing-slack">Preparing Slack</h2>

<p>To send notifications from Event Streams to your Slack channel, configure an incoming webhook URL within your Slack service. The webhook URL provided by Slack is required for the integration steps later in this section. To create the webhook URL:</p>

<ol>
  <li>Open Slack and go to your Slack channel where you want the notifications to be sent.</li>
  <li>From your Slack channel click the icon for <strong>Channel Settings</strong>, and select <strong>Add apps</strong> or <strong>Add an app</strong> depending on the Slack plan you are using.</li>
  <li>Search for “Incoming Webhooks”.</li>
  <li>Click <strong>Add configuration</strong>.</li>
  <li>Select the channel that you want to post to.</li>
  <li>Click <strong>Add Incoming Webhooks integration</strong>.</li>
  <li>Copy the URL in the <strong>Webhook URL</strong> field.</li>
</ol>

<p>For more information about incoming webhooks in Slack, see the <a href="https://api.slack.com/incoming-webhooks" target="_blank">Slack documentation</a>.</p>

<h2 id="selecting-the-metric-to-monitor">Selecting the metric to monitor</h2>

<p>To retrieve a list of available metrics, use an HTTP GET request on your ICP cluster URL as follows:</p>

<ol>
  <li>Log in to your IBM Cloud Private cluster management console from a supported web browser by using the URL <code class="language-plaintext highlighter-rouge">https://&lt;Cluster Master Host&gt;:8443</code>.</li>
  <li>Use the following request: <code class="language-plaintext highlighter-rouge">https://&lt;Cluster Master Host&gt;:8443/prometheus/api/v1/label/__name__/values</code><br />
The list of available metrics is displayed.</li>
  <li>Select a metric to monitor.</li>
</ol>

<p>For example, to test the triggering of alerts, you can monitor the total number of partitions for all topics by using the <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_partitioncount_value</code> metric. When topics are created, this metric can trigger notifications.</p>

<p>For production environments, a good metric to monitor is the number of under-replicated partitions as it tells you about potential problems with your Kafka cluster, such as load or network problems where the cluster becomes overloaded and followers are not able to catch up on leaders. Under-replicated partitions might be a temporary problem, but if it continues for longer, it probably requires urgent attention. An example is to set up a notification trigger to your Slack channel if the number of under-replicated partitions is greater than 0 for more than a minute. You can do this with the <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_underreplicatedpartitions_value</code> metric.</p>

<p>The examples in this tutorial show you how to set up monitoring for both of these metrics, with the purpose of testing notification triggers, and also to have a production environment example.</p>

<p><strong>Note:</strong> Not all of the metrics that Kafka uses are published to Prometheus by default. The metrics that are published are controlled by a ConfigMap. You can publish metrics by adding them to the ConfigMap.</p>

<p>For information about the different metrics, see <a href="https://kafka.apache.org/documentation/#monitoring" target="_blank">Monitoring Kafka</a>.</p>

<h2 id="setting-the-alert-rule">Setting the alert rule</h2>

<p>To set up the alert rule and define the trigger criteria, use the <code class="language-plaintext highlighter-rouge">monitoring-prometheus-alertrules</code> ConfigMap.</p>

<p>By default, the list of rules is empty. See the <code class="language-plaintext highlighter-rouge">data</code> section of the ConfigMap, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user$ kubectl get configmap -n kube-system monitoring-prometheus-alertrules -o yaml

apiVersion: v1
data:
  alert.rules: ""
kind: ConfigMap
metadata:
  creationTimestamp: 2019-04-05T13:07:48Z
  labels:
    app: monitoring-prometheus
    chart: ibm-icpmonitoring-1.2.0
    component: prometheus
    heritage: Tiller
    release: monitoring
  name: monitoring-prometheus-alertrules
  namespace: kube-system
  resourceVersion: "4564"
  selfLink: /api/v1/namespaces/kube-system/configmaps/monitoring-prometheus-alertrules
  uid: a87b5766-c89f-11e8-9f94-00000a3304c0
</code></pre></div></div>

<h3 id="example-test-setup">Example test setup</h3>

<p>As mentioned earlier, to test the triggering of alerts, you can monitor the total number of partitions for all topics by using the <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_partitioncount_value</code> metric.</p>

<p>Define an alert rule that creates a notification if the number of partitions increases. To achieve this, add a new rule for <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_partitioncount_value</code>, and set the trigger conditions in the <code class="language-plaintext highlighter-rouge">data</code> section, for example:</p>

<p><strong>Note:</strong> In this example, we are setting a threshold value of 50 as the built-in consumer-offsets topic has 50 partitions by default already, and this topic is automatically created the first time a consumer application connects to the cluster. We will create a topic later with 10 partitions to <a href="#testing">test</a> the firing of the alert and the subsequent notification to the Slack channel.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user$ kubectl edit configmap -n kube-system monitoring-prometheus-alertrules

apiVersion: v1
data:
  sample.rules: |-
    groups:
    - name: alert.rules
      #
      # Each of the alerts you want to create will be listed here
      rules:
      # Posts an alert if the number of partitions increases
      - alert: PartitionCount
        expr: kafka_server_replicamanager_partitioncount_value &gt; 50
        for: 10s
        labels:
          # Labels should match the alert manager so that it is received by the Slack hook
          severity: critical
        # The contents of the Slack messages that are posted are defined here
        annotations:
          identifier: "Partition count"
          description: "There are {{ $value }} partition(s) reported by broker {{ $labels.kafka }}"
kind: ConfigMap
metadata:
  creationTimestamp: 2019-04-05T13:07:48Z
  labels:
    app: monitoring-prometheus
    chart: ibm-icpmonitoring-1.2.0
    component: prometheus
    heritage: Tiller
    release: monitoring
  name: monitoring-prometheus-alertrules
  namespace: kube-system
  resourceVersion: "84156"
  selfLink: /api/v1/namespaces/kube-system/configmaps/monitoring-prometheus-alertrules
  uid: a87b5766-c89f-11e8-9f94-00000a3304c0
</code></pre></div></div>

<p><strong>Important:</strong> As noted in the prerequisites, this tutorial is based on IBM Cloud Private 3.1.1. Setting up alert rules is different if you are using IBM Cloud Private 3.1.2 or later, as each alert rule is a dedicated Kubernetes resource instead of being defined in a ConfigMap.</p>

<p>This means that instead of adding alert rule entries to a ConfigMap, you create a separate alert rule resource for each alert you want to enable.</p>

<p>In addition, the alert rules don’t need to be in the <code class="language-plaintext highlighter-rouge">kube-system</code> namespace, they can be added to the namespace where your release is deployed. This also means you don’t have to be a Cluster administrator to add alert rules.</p>

<p>For example, to create the rule by using a dedicated alert rule, you can save it to a file as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: monitoringcontroller.cloud.ibm.com/v1
kind: AlertRule
metadata:
  labels:
    app: monitoring-prometheus
    chart: ibm-icpmonitoring-1.4.0
    component: prometheus
    heritage: Tiller
    release: RELEASENAME
  name: partition-count
  namespace: NAMESPACE
spec:
  data: |-
    groups:
      - name: PartitionCount
        rules:
          - alert: PartitionCount
            expr: kafka_server_replicamanager_partitioncount_value &gt; 50
            for: 10s
            labels:
              severity: critical
            annotations:
              identifier: 'Partition count'
              description: 'There are {{ $value }} partition(s) reported by broker {{ $labels.kafka }}'
  enabled: true
</code></pre></div></div>

<p>To review your alert rules set up this way, use the <code class="language-plaintext highlighter-rouge">kubectl get alertrules</code> command, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get alertrules
NAME                          ENABLED   AGE   CHART                     RELEASE         ERRORS
partition-count               true      1h    ibm-icpmonitoring-1.4.0   es-demo
</code></pre></div></div>

<h3 id="example-production-setup">Example production setup</h3>

<p>As mentioned earlier, a good metric to monitor in production environments is the metric <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_underreplicatedpartitions_value</code>, for which we want to define an alert rule that creates a notification if the number of under-replicated partitions is greater than 0 for more than a minute. To achieve this, add a new rule for <code class="language-plaintext highlighter-rouge">kafka_server_replicamanager_underreplicatedpartitions_value</code>, and set the trigger conditions in the <code class="language-plaintext highlighter-rouge">data</code> section, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user$ kubectl edit configmap -n kube-system monitoring-prometheus-alertrules

apiVersion: v1
data:
  sample.rules: |-
    groups:
    - name: alert.rules
      #
      # Each of the alerts you want to create will be listed here
      rules:
      # Posts an alert if there are any under-replicated partitions
      #  for longer than a minute
      - alert: under_replicated_partitions
        expr: kafka_server_replicamanager_underreplicatedpartitions_value &gt; 0
        for: 1m
        labels:
          # Labels should match the alert manager so that it is received by the Slack hook
          severity: critical
        # The contents of the Slack messages that are posted are defined here
        annotations:
          identifier: "Under-replicated partitions"
          description: "There are {{ $value }} under-replicated partition(s) reported by broker {{ $labels.kafka }}"
kind: ConfigMap
metadata:
  creationTimestamp: 2019-04-05T13:07:48Z
  labels:
    app: monitoring-prometheus
    chart: ibm-icpmonitoring-1.2.0
    component: prometheus
    heritage: Tiller
    release: monitoring
  name: monitoring-prometheus-alertrules
  namespace: kube-system
  resourceVersion: "84156"
  selfLink: /api/v1/namespaces/kube-system/configmaps/monitoring-prometheus-alertrules
  uid: a87b5766-c89f-11e8-9f94-00000a3304c0
</code></pre></div></div>

<p><strong>Important:</strong> As noted in the prerequisites, this tutorial is based on IBM Cloud Private 3.1.1. Setting up alert rules is different if you are using IBM Cloud Private 3.1.2 or later, as each alert rule is a dedicated Kubernetes resource instead of being defined in a ConfigMap.</p>

<p>This means that instead of adding alert rule entries to a ConfigMap, you create a separate alert rule resource for each alert you want to enable.</p>

<p>In addition, the alert rules don’t need to be in the <code class="language-plaintext highlighter-rouge">kube-system</code> namespace, they can be added to the namespace where your release is deployed. This also means you don’t have to be a Cluster administrator to add alert rules.</p>

<p>For example, to create the rule by using a dedicated alert rule, you can save it to a file as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: monitoringcontroller.cloud.ibm.com/v1
kind: AlertRule
metadata:
  labels:
    app: monitoring-prometheus
    chart: ibm-icpmonitoring-1.4.0
    component: prometheus
    heritage: Tiller
    release: RELEASENAME
  name: under-replicated-partitions
  namespace: NAMESPACE
spec:
  data: |-
    groups:
      - name: UnderReplicatedPartitions
        rules:
          - alert: UnderReplicatedPartitions
            expr: kafka_server_replicamanager_underreplicatedpartitions_value &gt; 0
            for: 1m
            labels:
              severity: critical
            annotations:
              identifier: 'Under-replicated partitions'
              description: 'There are {{ $value }} under-replicated partition(s) reported by broker {{ $labels.kafka }}'
  enabled: true
</code></pre></div></div>

<p>To review your alert rules set up this way, use the <code class="language-plaintext highlighter-rouge">kubectl get alertrules</code> command, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get alertrules
NAME                          ENABLED   AGE   CHART                     RELEASE         ERRORS
under-replicated-partitions   true      1h    ibm-icpmonitoring-1.4.0   es-prod
</code></pre></div></div>

<h2 id="defining-the-alert-destination">Defining the alert destination</h2>

<p>To define where to send the notifications triggered by the alert rule, specify Slack as a receiver by adding details about your Slack channel and the webhook you copied earlier to the <code class="language-plaintext highlighter-rouge">monitoring-prometheus-alertmanager</code> ConfigMap. For more information about Prometheus Alertmanager, see the <a href="https://prometheus.io/docs/alerting/configuration/" target="_blank">Prometheus documentation</a>.</p>

<p>By default, the list of receivers is empty. See the <code class="language-plaintext highlighter-rouge">data</code> section of the ConfigMap, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user$ kubectl get configmap -n kube-system monitoring-prometheus-alertmanager -o yaml

apiVersion: v1
data:
  alertmanager.yml: |-
    global:
    receivers:
      - name: default-receiver
    route:
      group_wait: 10s
      group_interval: 5m
      receiver: default-receiver
      repeat_interval: 3h
kind: ConfigMap
metadata:
  creationTimestamp: 2019-04-05T13:07:48Z
  labels:
    app: monitoring-prometheus
    chart: ibm-icpmonitoring-1.2.0
    component: alertmanager
    heritage: Tiller
    release: monitoring
  name: monitoring-prometheus-alertmanager
  namespace: kube-system
  resourceVersion: "4565"
  selfLink: /api/v1/namespaces/kube-system/configmaps/monitoring-prometheus-alertmanager
  uid: a87bdb44-c89f-11e8-9f94-00000a3304c0
</code></pre></div></div>

<p>Define the Slack channel as the receiver using the incoming webhook you copied earlier, and also set up the notification details such as the channel to post to, the content format, and criteria for the events to send to Slack. Settings to configure include the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">slack_api_url</code>: The incoming webhook generated in Slack earlier.</li>
  <li><code class="language-plaintext highlighter-rouge">send_resolved</code>: Set to <code class="language-plaintext highlighter-rouge">true</code> to send notifications about resolved alerts.</li>
  <li><code class="language-plaintext highlighter-rouge">channel</code>: The Slack channel to send the notifications to.</li>
  <li><code class="language-plaintext highlighter-rouge">username</code>: The username that posts the alert notifications to the channel.</li>
</ul>

<p>For more information about the configuration settings to enter for Slack notifications, see the <a href="https://prometheus.io/docs/alerting/configuration/#slack_config" target="_blank">Prometheus documentation</a>.</p>

<p>The content for the posts can be customized, see the following <a href="https://medium.com/quiq-blog/better-slack-alerts-from-prometheus-49125c8c672b" target="_blank">blog</a> for Slack alert examples from Prometheus.</p>

<p>For example, to set up Slack notifications for your alert rule created earlier:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user$ kubectl edit configmap -n kube-system monitoring-prometheus-alertmanager
apiVersion: v1
data:
  alertmanager.yml: |-
    global:
      # This is the URL for the Incoming Webhook you created in Slack
      slack_api_url:  https://hooks.slack.com/services/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
    receivers:
      - name: default-receiver
        #
        # Adding a Slack channel integration to the default Prometheus receiver
        #  see https://prometheus.io/docs/alerting/configuration/#slack_config
        #  for details about the values to enter
        slack_configs:
        - send_resolved: true

          # The name of the Slack channel that alerts should be posted to
          channel: "#ibm-eventstreams-demo"

          # The username to post alerts as
          username: "IBM Event Streams"

          # An icon for posts in Slack
          icon_url: https://developer.ibm.com/messaging/wp-content/uploads/sites/18/2018/09/icon_dev_32_24x24.png

          #
          # The content for posts to Slack when alert conditions are fired
          # Improves on the formatting from the default, with support for handling
          #  alerts containing multiple events.
          # (Modified from the examples in
          #   https://medium.com/quiq-blog/better-slack-alerts-from-prometheus-49125c8c672b)
          title: |-
            [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if or (and (eq (len .Alerts.Firing) 1) (eq (len .Alerts.Resolved) 0)) (and (eq (len .Alerts.Firing) 0) (eq (len .Alerts.Resolved) 1)) }}{{ range .Alerts.Firing }} @ {{ .Annotations.identifier }}{{ end }}{{ range .Alerts.Resolved }} @ {{ .Annotations.identifier }}{{ end }}{{ end }}
          text: |-
            {{ if or (and (eq (len .Alerts.Firing) 1) (eq (len .Alerts.Resolved) 0)) (and (eq (len .Alerts.Firing) 0) (eq (len .Alerts.Resolved) 1)) }}
            {{ range .Alerts.Firing }}{{ .Annotations.description }}{{ end }}{{ range .Alerts.Resolved }}{{ .Annotations.description }}{{ end }}
            {{ else }}
            {{ if gt (len .Alerts.Firing) 0 }}
            *Alerts Firing:*
            {{ range .Alerts.Firing }}- {{ .Annotations.identifier }}: {{ .Annotations.description }}
            {{ end }}{{ end }}
            {{ if gt (len .Alerts.Resolved) 0 }}
            *Alerts Resolved:*
            {{ range .Alerts.Resolved }}- {{ .Annotations.identifier }}: {{ .Annotations.description }}
            {{ end }}{{ end }}
            {{ end }}
    route:
      group_wait: 10s
      group_interval: 5m
      receiver: default-receiver
      repeat_interval: 3h
      #
      # The criteria for events that should go to Slack
      routes:
      - match:
          severity: critical
        receiver: default-receiver
kind: ConfigMap
metadata:
  creationTimestamp: 2019-04-05T13:07:48Z
  labels:
    app: monitoring-prometheus
    chart: ibm-icpmonitoring-1.2.0
    component: alertmanager
    heritage: Tiller
    release: monitoring
  name: monitoring-prometheus-alertmanager
  namespace: kube-system
  resourceVersion: "4565"
  selfLink: /api/v1/namespaces/kube-system/configmaps/monitoring-prometheus-alertmanager
  uid: a87bdb44-c89f-11e8-9f94-00000a3304c0
</code></pre></div></div>

<p>To check that the new alert is set up, use the Prometheus UI as follows:</p>

<ol>
  <li>Log in to your IBM Cloud Private cluster management console from a supported web browser by using the URL <code class="language-plaintext highlighter-rouge">https://&lt;Cluster Master Host&gt;:8443</code>.</li>
  <li>Go to the Prometheus UI at <code class="language-plaintext highlighter-rouge">https://&lt;Cluster Master Host&gt;:8443/prometheus</code>, and click the <strong>Alerts</strong> tab to see the active alerts. You can also go to <strong>Status &gt; Rules</strong> to view the defined alert rules.</li>
</ol>

<p>For example:</p>

<p><img src="../../images/alert_rules.png" alt="Prometheus alert rules" title="Screen capture showing the alert rule for the under_replicated_partitions alert in the Prometheus UI." /></p>

<p><img src="../../images/alerts.png" alt="Prometheus alert rules" title="Screen capture showing the details for the under_replicated_partitions alert in the Prometheus UI." /></p>

<h2 id="testing">Testing</h2>

<h3 id="example-test-setup-1">Example test setup</h3>

<p>To create a notification for the test setup, create a topic with 10 partitions as follows:</p>

<ol>
  <li>Log in to your IBM Event Streams UI.</li>
  <li>Click the <strong>Topics</strong> tab.</li>
  <li>Click <strong>Create topic</strong>.</li>
  <li>Follow the instructions to create the topic, and set the <strong>Partitions</strong> value to 10.</li>
</ol>

<p>The following notification is sent to the Slack channel when the topic is created:</p>

<p><img src="../../images/slack_alert_firing_test.png" alt="Alert firing message posted to Slack channel in test example" title="Screen capture showing the firing message posted to the Slack channel by the PartitionCount alert." /></p>

<p>To create a resolution alert, delete the topic you created previously:</p>

<ol>
  <li>Log in to your IBM Event Streams UI.</li>
  <li>Click the <strong>Topics</strong> tab.</li>
  <li>Go to the topic you created and click <img src="../../images/more_options.png" alt="More options icon" title="Three vertical dots for the more options icon at end of each row." height="30px" width="15px" /> <strong>More options &gt; Delete this topic</strong>.</li>
</ol>

<p>When the topic is deleted, the following resolution alert is posted:</p>

<p><img src="../../images/slack_alert_resolved_test.png" alt="Alert resolved message posted to Slack channel in test example" title="Screen capture showing the resolved message posted to the Slack channel by the PartitionCount alert." /></p>

<h3 id="example-production-setup-1">Example production setup</h3>

<p>For the production environment example, the following notification is posted to the Slack channel if the number of under-replicated partitions remains above 0 for a minute:</p>

<p><img src="../../images/slack_alert_firing.png" alt="Alert firing message posted to Slack channel in production example" title="Screen capture showing the firing message posted to the Slack channel by the under_replicated_partitions alert." /></p>

<p>When the cluster recovers, a new resolution alert is posted when the number of under-replicated partitions returns to 0. This is based on the <code class="language-plaintext highlighter-rouge">send_resolved</code> setting (was set to <code class="language-plaintext highlighter-rouge">true</code>).</p>

<p><img src="../../images/slack_alert_resolved.png" alt="Alert resolved message posted to Slack channel in production example" title="Screen capture showing the resolved message posted to the Slack channel by the under_replicated_partitions alert." /></p>

<h2 id="setting-up-other-notifications">Setting up other notifications</h2>

<p>You can use this example to set up alert notifications to other applications, including <a href="https://prometheus.io/docs/alerting/configuration/#hipchat_config" target="_blank">HipChat</a>, <a href="https://prometheus.io/docs/alerting/configuration/#pagerduty_config" target="_blank">PagerDuty</a>, <a href="https://prometheus.io/docs/alerting/configuration/#email_config" target="_blank">emails</a>, and so on. You can also use this technique to generate HTTP calls, which lets you customize alerts when defining a flow in tools like <a href="https://nodered.org/" target="_blank">Node-RED</a> or <a href="https://developer.ibm.com/integration/docs/" target="_blank">IBM App Connect</a>.</p>

          </div>


          
        </section>

        <aside class="sidebar__right ">
          
          <div class="fixedSidebar">
            <nav class="toc">
              <ul class="toc__menu">
  <li><a href="#prerequisites">Prerequisites</a></li>
  <li><a href="#preparing-slack">Preparing Slack</a></li>
  <li><a href="#selecting-the-metric-to-monitor">Selecting the metric to monitor</a></li>
  <li><a href="#setting-the-alert-rule">Setting the alert rule</a>
    <ul>
      <li><a href="#example-test-setup">Example test setup</a></li>
      <li><a href="#example-production-setup">Example production setup</a></li>
    </ul>
  </li>
  <li><a href="#defining-the-alert-destination">Defining the alert destination</a></li>
  <li><a href="#testing">Testing</a>
    <ul>
      <li><a href="#example-test-setup-1">Example test setup</a></li>
      <li><a href="#example-production-setup-1">Example production setup</a></li>
    </ul>
  </li>
  <li><a href="#setting-up-other-notifications">Setting up other notifications</a></li>
</ul>
            </nav>
          </div>
          
        </aside>


      </div>
      <div class="pageEnd">
        
      </div>
    </div>


  </div> <!-- Main content -->

</main></div>


    
      <div class="page__footer">
          <footer>
            <!-- start custom footer snippets -->

<!-- end custom footer snippets -->

            
<div class="page__footer-copyright"><a href="https://www.ibm.com/privacy/us/en/" rel="nofollow" target="_blank">Privacy Policy</a>  &nbsp;© Copyright IBM Corporation 2020</br>
  Released under the <a href="https://www.apache.org/licenses/LICENSE-2.0" rel="nofollow" target="_blank">Apache License v2.0</a></div>

          </footer>
      </div>      
    


    
  <script src="/FHIR-Server-Docs/assets/js/main.min.js"></script>
  <!-- <script src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script> -->






<script src="/FHIR-Server-Docs/assets/js/design.js"></script>





<script src="/FHIR-Server-Docs/assets/js/lunr/lunr.min.js"></script>
<script src="/FHIR-Server-Docs/assets/js/lunr/lunr-store.js"></script>
<script src="/FHIR-Server-Docs/assets/js/lunr/lunr-en.js"></script>





    

    
  </body>
</html>
